<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google OAuth Flow Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üîç Google OAuth Flow Test</h1>
    
    <div class="test-section">
        <h2>Test 1: Server Health Check</h2>
        <button onclick="testServerHealth()">Test Server Health</button>
        <div id="health-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Google OAuth Endpoint</h2>
        <button onclick="testGoogleOAuth()">Test Google OAuth</button>
        <div id="oauth-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: Simulate OAuth Callback</h2>
        <button onclick="simulateCallback()">Simulate Callback</button>
        <div id="callback-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 4: Token Validation</h2>
        <button onclick="testTokenValidation()">Test Token Validation</button>
        <div id="token-result"></div>
    </div>

    <div class="test-section">
        <h2>Test Logs</h2>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function testServerHealth() {
            const resultDiv = document.getElementById('health-result');
            resultDiv.innerHTML = '<p>Testing...</p>';
            
            try {
                const response = await fetch('https://api.bittrr.com/health');
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<p class="success">‚úÖ Server is healthy: ${JSON.stringify(data)}</p>`;
                    log('Server health check passed', 'success');
                } else {
                    resultDiv.innerHTML = `<p class="error">‚ùå Server health check failed: ${response.status}</p>`;
                    log('Server health check failed', 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Server health check error: ${error.message}</p>`;
                log(`Server health check error: ${error.message}`, 'error');
            }
        }

        async function testGoogleOAuth() {
            const resultDiv = document.getElementById('oauth-result');
            resultDiv.innerHTML = '<p>Testing...</p>';
            
            try {
                // Test if the OAuth endpoint redirects properly
                const response = await fetch('https://api.bittrr.com/auth/google', {
                    method: 'GET',
                    redirect: 'manual'
                });
                
                if (response.status === 302) {
                    const redirectUrl = response.headers.get('location');
                    resultDiv.innerHTML = `<p class="success">‚úÖ Google OAuth endpoint working</p>
                                         <p class="info">Redirect URL: ${redirectUrl}</p>`;
                    log('Google OAuth endpoint working', 'success');
                    log(`Redirect URL: ${redirectUrl}`, 'info');
                } else {
                    resultDiv.innerHTML = `<p class="error">‚ùå Unexpected response: ${response.status}</p>`;
                    log(`Unexpected OAuth response: ${response.status}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Google OAuth test error: ${error.message}</p>`;
                log(`Google OAuth test error: ${error.message}`, 'error');
            }
        }

        function simulateCallback() {
            const resultDiv = document.getElementById('callback-result');
            resultDiv.innerHTML = '<p>Simulating...</p>';
            
            // Simulate the callback URL that would be generated
            const mockToken = 'mock-jwt-token-123';
            const mockUser = {
                _id: 'mock-user-id',
                name: 'Test User',
                email: 'test@example.com',
                googleId: 'mock-google-id',
                photos: [{ url: 'https://example.com/photo.jpg', isVerified: true }],
                isEmailVerified: true,
                isVerified: true,
                location: { city: '', country: '', coordinates: [0, 0] },
                interests: [],
                bio: '',
                preferences: { ageRange: { min: 18, max: 99 }, distance: 50 },
                lastActive: new Date().toISOString(),
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            const callbackUrl = `https://www.bittrr.com/auth-success?token=${mockToken}&user=${encodeURIComponent(JSON.stringify(mockUser))}`;
            
            resultDiv.innerHTML = `<p class="success">‚úÖ Callback URL generated</p>
                                 <p class="info">URL: ${callbackUrl}</p>
                                 <button onclick="window.open('${callbackUrl}', '_blank')">Open Callback URL</button>`;
            
            log('Callback URL generated', 'success');
            log(`URL: ${callbackUrl}`, 'info');
        }

        async function testTokenValidation() {
            const resultDiv = document.getElementById('token-result');
            resultDiv.innerHTML = '<p>Testing...</p>';
            
            try {
                // Test with invalid token
                const response = await fetch('https://api.bittrr.com/auth/validate', {
                    headers: {
                        'Authorization': 'Bearer invalid-token'
                    }
                });
                
                if (response.status === 401) {
                    resultDiv.innerHTML = `<p class="success">‚úÖ Token validation correctly rejects invalid tokens</p>`;
                    log('Token validation working correctly', 'success');
                } else {
                    resultDiv.innerHTML = `<p class="error">‚ùå Token validation should return 401, got ${response.status}</p>`;
                    log(`Token validation unexpected response: ${response.status}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Token validation test error: ${error.message}</p>`;
                log(`Token validation test error: ${error.message}`, 'error');
            }
        }

        // Auto-run tests on page load
        window.onload = function() {
            log('Google OAuth Flow Test Started', 'info');
            testServerHealth();
        };
    </script>
</body>
</html> 